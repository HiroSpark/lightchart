\NeedsTeXFormat{LaTeX2e}
\RequirePackage{xparse,xcolor}
\ProvidesExplPackage{simplegraph}
  {2020/09/06}
  {0.1}
  {}

% キーの定義
\keys_define:nn { sgraph }{
  height  .dim_set:N    = \l__sgraph_graph_height_dim,
  width   .dim_set:N    = \l__sgraph_graph_width_dim,
  colors  .tl_set:N     = \l__sgraph_colors_tl,
  unit    .tl_set:N     = \l__sgraph_unit_tl
}

% [command] デフォルトの設定をする
% \simplegraphsetup{ <options> }
\NewDocumentCommand{ \simplegraphsetup }{ m }
  {
    \keys_set:nn { sgraph }{ #1 }
  }

% [command] グラフを描画する
% \makegraph{ <graph-type> }{ <data> }[ <options> ]
\seq_new:N  \l__sgraph_colors_seq
\prop_new:N \l__sgraph_value_list_prop
\seq_new:N  \l__sgraph_keys_list_seq
\prop_new:N \l__sgraph_ratio_prop
\cs_generate_variant:Nn \seq_set_split:Nnn { NnV }

\NewDocumentCommand{ \makegraph }{ m m O{} }
  {
    % <options>
    \keys_set:nn { sgraph }{ #3 }
    \seq_set_split:NnV \l__sgraph_colors_seq { , } \l__sgraph_colors_tl
    % <data>
    \prop_set_from_keyval:Nn \l__sgraph_value_list_prop { #2 }
    \prop_clear:N \l__sgraph_keys_list_seq
    \__sgraph_get_keys_list:Nn \l__sgraph_keys_list_seq { #2 }
    \prop_clear:N \l__sgraph_ratio_prop
    \__sgraph_process_data:NN \l__sgraph_ratio_prop \l__sgraph_value_list_prop

    % グラフの描画
    \str_if_eq:NNTF { #1 }{ band }
      {
        % 帯グラフ
        \__sgraph_draw_graph:VVVVVVV
          \l__sgraph_keys_list_seq
          \l__sgraph_value_list_prop
          \l__sgraph_ratio_prop
          \l__sgraph_graph_width_dim
          \l__sgraph_graph_height_dim
          \l__sgraph_colors_seq
          \l__sgraph_unit_tl
      }{}
  }

% [function] graph を描く
% #: keys list (seq)
% #: key=value list (prop)
% #: key=ratio list (prop)
% #: graph width (dim)
% #: graph height (dim)
% #: colors list (seq)
% #: unit (tl)
\int_new:N  \l___sgraph_this_value_index_int
\tl_new:N   \l___sgraph_this_value_ratio_tl
\fp_new:N   \l___sgraph_this_value_ratio_fp
\fp_new:N   \l___sgraph_this_graph_width_fp
\fp_new:N   \l___sgraph_this_start_position_fp
\fp_new:N   \l___sgraph_next_start_position_fp
\fp_new:N   \l___sgraph_this_label_position_x_fp
\fp_new:N   \l___sgraph_label_position_y_fp
\cs_generate_variant:Nn \fp_set:Nn { NV }

\cs_new:Npn \__sgraph_draw_graph:VVVVVVV #1 #2 #3 #4 #5 #6 #7
  {
    % 値のリセット
    \int_set:Nn \l___sgraph_this_value_index_int { 1 }
    \fp_zero:N  \l___sgraph_this_start_position_fp
    % ラベルの y 座標の位置を求める
    \fp_set:Nn  \l___sgraph_label_position_y_fp
      { \dim_to_fp:n { #5 } / 2 }
    \begin{ picture }(345,100)
      % key ごとに処理
      \seq_map_inline:Nn #1
        {
          % グラフを描く幅を求める
          \prop_get:NnN #3 { ##1 } \l___sgraph_this_value_ratio_tl
          \fp_set:NV \l___sgraph_this_value_ratio_fp \l___sgraph_this_value_ratio_tl
          \fp_set:Nn \l___sgraph_this_graph_width_fp
            {
              \dim_to_fp:n { #4 } * \l___sgraph_this_value_ratio_fp
            }
          \fp_set:Nn \l___sgraph_next_start_position_fp
            {
              \l___sgraph_this_start_position_fp + \l___sgraph_this_graph_width_fp
            }
          % ラベルの x 座標の位置を求める
          \fp_set:Nn \l___sgraph_this_label_position_x_fp
            {
              \l___sgraph_this_start_position_fp + 2
            }
          % グラフを描く
          \put( \fp_to_tl:N \l___sgraph_this_start_position_fp, 0 )
            {
              \__sgraph_draw_rectangle:nnnn
                {}
                { \seq_item:Nn #6 { \l___sgraph_this_value_index_int } }
                { \l___sgraph_this_graph_width_fp }
                { \dim_to_fp:n { #5 } }
            }
          % ラベルの描画
          \put(
            \fp_to_tl:N \l___sgraph_this_label_position_x_fp,
            \fp_to_tl:N \l___sgraph_label_position_y_fp
          ){ ##1 #7 }
          % 値を更新
          \fp_set_eq:NN
            \l___sgraph_this_start_position_fp
            \l___sgraph_next_start_position_fp
          % index に +1
          \int_add:Nn \l___sgraph_this_value_index_int { 1 }
        }
    \end{ picture }
  }

% [function] 色付きの四角形を描く（picure 環境内のみ）
% #: border-color (seq)
% #: buckground-color (seq)
% #: width (fp)
% #: height (fp)
\cs_new:Npn \__sgraph_draw_rectangle:nnnn #1 #2 #3 #4
  {
    \fcolorbox{ black }{ #2 }
      { \makebox( \fp_to_tl:n { #3 }, \fp_to_tl:n { #4 } ){} }
  }

% [function] keys list を求める
% # (return): keys list (seq)
% # (arg): key=value list (tl)
\seq_new:N  \l___sgraph_split_by_comma_seq
\seq_new:N  \l___sgraph_key_seq
\seq_new:N  \l___sgraph_key_value_seq
\cs_generate_variant:Nn \tl_put_right:Nn { NV }

\cs_new:Npn \__sgraph_get_keys_list:Nn #1 #2
  {
    \seq_set_split:Nnn \l___sgraph_split_by_comma_seq { , }{ #2 }
    \seq_map_inline:Nn \l___sgraph_split_by_comma_seq
      {
        \seq_set_split:Nnn  \l___sgraph_key_value_seq { = }{ ##1 }
        \seq_pop_left:NN    \l___sgraph_key_value_seq \l___sgraph_key_seq
        \seq_put_right:NV   #1 \l___sgraph_key_seq
      }
  }

% [function] key=ratio を求める
% # (return): key=ratio (prop)
% # (arg): key=val (prop)
\fp_new:N   \l__sgraph_data_sum_fp
\fp_new:N   \l__sgraph_values_ratio_fp
\cs_generate_variant:Nn \prop_put:Nnn { NnV }

\cs_new:Npn \__sgraph_process_data:NN #1 #2
  {
    \fp_zero:N \l__sgraph_data_sum_fp
    \prop_map_inline:Nn #2
      {
        \fp_add:Nn \l__sgraph_data_sum_fp { ##2 }
      }
    \prop_map_inline:Nn #2
      {
        \fp_set:Nn    \l__sgraph_values_ratio_fp { ##2 / \l__sgraph_data_sum_fp }
        \prop_put:NnV #1 { ##1 } \l__sgraph_values_ratio_fp
      }
  }