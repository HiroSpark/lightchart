\NeedsTeXFormat{LaTeX2e}
\RequirePackage{xparse,tikz}
\ProvidesExplPackage{simplegraph}
  {2020/09/06}
  {0.1}
  {}

% キーの定義
\keys_define:nn { vgraph }{
  height  .dim_set:N    = \l__vgraph_graph_height_dim,
  width   .dim_set:N    = \l__vgraph_graph_width_dim,
  colors  .tl_set:N     = \l__vgraph_colors_tl,
  unit    .tl_set:N     = \l__vgraph_unit_tl
}

% [commmand] グラフを描画する
% \makegraph{ <graph-type> }{ <data> }[ <options> ]
\cs_generate_variant:Nn \seq_set_split:Nnn {NnV}
\NewDocumentCommand{ \makegraph }{ m m O{} }{

  % <options>
  % キーの設定
  \keys_set:nn  { vgraph }{ #3 }
  % colors
  \seq_new:N  \l__vgraph_colors_seq
  \seq_set_split:NnV \l__vgraph_colors_seq { , } \l__vgraph_colors_tl
  \seq_show:N \l__vgraph_colors_seq

  % <data> を prop にする
  \prop_new:N \l__vgraph_value_list_prop
  \prop_set_from_keyval:Nn \l__vgraph_value_list_prop { #2 }

  % <data> から keys list を取得する
  \seq_new:N   \l__vgraph_keys_list_seq
  \__vgraph_get_keys_list:Nn  \l__vgraph_keys_list_seq { #2 }

  % データの処理
  \prop_new:N  \l__vgraph_ratio_prop
  \__vgraph_process_data:Nn \l__vgraph_ratio_prop { #2 }

  % グラフの描画
  \str_if_eq:NNTF  { #1 }{ band }{
    % 帯グラフ
    \__vgraph_draw_graph:VVVVVVV
      \l__vgraph_keys_list_seq
      \l__vgraph_value_list_prop
      \l__vgraph_ratio_prop
      \l__vgraph_graph_width_dim
      \l__vgraph_graph_height_dim
      \l__vgraph_colors_seq
      \l__vgraph_unit_tl
  }{}

}

% [function] graph を描く
% (key) = {(ratio), (data)} の形のデータを受け取り、帯グラフを描画する。
% #: keys list (seq)
% #: key=value list (prop)
% #: key=ratio list (prop)
% #: graph width (dim)
% #: graph height (dim)
% #: colors list (seq)
% #: unit (seq)
\tl_new:N   \l___vgraph_this_value_ratio_tl   % for current value's value ratio
\fp_new:N   \l___vgraph_this_value_ratio_fp   % for current value's value ratio
\dim_new:N  \l___vgraph_this_graph_width_dim  % for current value's graph width
\dim_new:N  \l___vgraph_this_graph_width_fp   % for current value's graph width
\dim_new:N  \l___vgraph_this_start_position_dim
\dim_zero:N \l___vgraph_this_start_position_dim
\dim_new:N  \l___vgraph_this_end_position_dim
\cs_generate_variant:Nn \fp_set:Nn { NV }
\cs_new:Npn \__vgraph_draw_graph:VVVVVVV #1 #2 #3 #4 #5 #6 #7
  {
    \seq_map_inline:Nn #1
      {
        % グラフを描く幅を求める
        \prop_get:NnN #3 { ##1 } \l___vgraph_this_value_ratio_tl
        \fp_set:NV \l___vgraph_this_value_ratio_fp \l___vgraph_this_value_ratio_tl
        %\fp_show:N \l___vgraph_this_value_ratio_fp
        \fp_set:Nn \l___vgraph_this_graph_width_fp
          {
            \dim_to_fp:n { #4 } * \l___vgraph_this_value_ratio_fp
          }
        \dim_set:Nn \l___vgraph_this_graph_width_dim { \fp_to_dim:N \l___vgraph_this_graph_width_fp }
        \dim_set:Nn \l___vgraph_this_end_position_dim
          {
            \l___vgraph_this_start_position_dim + \l___vgraph_this_graph_width_dim
          }
        % グラフを描画する
        \begin{ tikzpicture }
          % 四角の描画
          \draw( \l___vgraph_this_start_position_dim, 0 )
          rectangle( \l___vgraph_this_end_position_dim, #5 );
          % ラベルの描画
        \end{ tikzpicture }
        % 値を更新
        \dim_set_eq:NN  \l___vgraph_this_start_position_dim \l___vgraph_this_end_position_dim
      }
  }

% [function] keys list を求める
% #1 (return): keys list (seq)
% #2 (arg): key=value list (tl)
\seq_new:N  \l___vgraph_split_by_comma_seq
\seq_new:N  \l___vgraph_keys_list_seq
\seq_new:N  \l___vgraph_key_seq
\seq_new:N  \l___vgraph_key_value_seq
\cs_generate_variant:Nn \tl_put_right:Nn {NV}
\cs_new:Npn \__vgraph_get_keys_list:Nn #1 #2
  {
    \seq_set_split:Nnn \l___vgraph_split_by_comma_seq { , }{ #2 }
    \seq_map_inline:Nn \l___vgraph_split_by_comma_seq
      {
        \seq_set_split:Nnn \l___vgraph_key_value_seq { = }{ ##1 }
        \seq_pop_left:NN  \l___vgraph_key_value_seq \l___vgraph_key_seq
        \seq_put_right:NV \l___vgraph_keys_list_seq \l___vgraph_key_seq
      }
    \seq_set_eq:NN #1 \l___vgraph_keys_list_seq
  }

% [function] key=ratio を求める
% #1(return): prop_val
% #2(arg): key=val (prop)
% key=value (prop), value sum (fp) -> key=ratio (prop)
% データを格納した keyval を受け取り、全体を 1 とした比率のデータが含まれた prop を返す
\cs_generate_variant:Nn \prop_put:Nnn { NnV }
\cs_new:Npn  \__vgraph_process_data:Nn #1 #2
  {
    \prop_new:N   \l__vgraph_original_data_prop
    \prop_set_from_keyval:Nn  \l__vgraph_original_data_prop { #2 }
    % \l__vgraph_original_data_prop の value の合計値を求める
    \fp_new:N     \l__vgraph_data_sum_fp
    \prop_map_inline:Nn \l__vgraph_original_data_prop
      {
        \fp_add:Nn \l__vgraph_data_sum_fp { ##2 }
      }
    % \l__vgraph_original_data_prop の value の比率を求めて新しい prop を作る
    \prop_new:N   \l__vgraph_ratio_data_prop
    \fp_new:N     \l__vgraph_values_ratio_fp
    \prop_map_inline:Nn \l__vgraph_original_data_prop
      {
        \fp_set:Nn    \l__vgraph_values_ratio_fp { ##2 / \l__vgraph_data_sum_fp }
        \prop_put:NnV \l__vgraph_ratio_data_prop { ##1 } \l__vgraph_values_ratio_fp
      }
    \prop_show:N  \l__vgraph_ratio_data_prop
    % #1 に代入
    \prop_set_eq:NN #1 \l__vgraph_ratio_data_prop
  }