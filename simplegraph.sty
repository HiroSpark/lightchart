\NeedsTeXFormat{LaTeX2e}
\RequirePackage{xparse,tikz}
\ProvidesExplPackage{simplegraph}
  {2020/09/06}
  {0.1}
  {}

% キーの定義
\keys_define:nn { sgraph }{
  height  .dim_set:N    = \l__sgraph_graph_height_dim,
  width   .dim_set:N    = \l__sgraph_graph_width_dim,
  colors  .tl_set:N     = \l__sgraph_colors_tl,
  unit    .tl_set:N     = \l__sgraph_unit_tl
}

% [command] デフォルトの設定をする
% \simplegraphsetup{ <options> }
\NewDocumentCommand{ \simplegraphsetup }{ m }{
  \keys_set:nn { sgraph }{ #1 }
}

% [command] グラフを描画する
% \makegraph{ <graph-type> }{ <data> }[ <options> ]
\seq_new:N  \l__sgraph_colors_seq
\prop_new:N \l__sgraph_value_list_prop
\seq_new:N  \l__sgraph_keys_list_seq
\prop_new:N \l__sgraph_ratio_prop
\cs_generate_variant:Nn \seq_set_split:Nnn { NnV }

\NewDocumentCommand{ \makegraph }{ m m O{} }{

  % <options>
  % キーの設定
  \keys_set:nn  { sgraph }{ #3 }
  % colors
  \seq_set_split:NnV \l__sgraph_colors_seq { , } \l__sgraph_colors_tl

  % <data> を prop にする
  \prop_set_from_keyval:Nn \l__sgraph_value_list_prop { #2 }

  % <data> から keys list を取得する
  \__sgraph_get_keys_list:Nn \l__sgraph_keys_list_seq { #2 }

  % データの処理
  \prop_clear:N \l__sgraph_ratio_prop
  \__sgraph_process_data:NN \l__sgraph_ratio_prop \l__sgraph_value_list_prop

  % グラフの描画
  \str_if_eq:NNTF { #1 }{ band }
    {
      % 帯グラフ
      \__sgraph_draw_graph:VVVVVVV
        \l__sgraph_keys_list_seq
        \l__sgraph_value_list_prop
        \l__sgraph_ratio_prop
        \l__sgraph_graph_width_dim
        \l__sgraph_graph_height_dim
        \l__sgraph_colors_seq
        \l__sgraph_unit_tl
    }{}

}

% [function] graph を描く
% #: keys list (seq)
% #: key=value list (prop)
% #: key=ratio list (prop)
% #: graph width (dim)
% #: graph height (dim)
% #: colors list (seq)
% #: unit (seq)
\int_new:N  \l___sgraph_this_value_index_int
\tl_new:N   \l___sgraph_this_value_ratio_tl
\fp_new:N   \l___sgraph_this_value_ratio_fp
\fp_new:N   \l___sgraph_this_graph_width_fp
\fp_new:N   \l___sgraph_this_start_position_fp
\fp_new:N   \l___sgraph_this_end_position_fp
\cs_generate_variant:Nn \fp_set:Nn { NV }

\cs_new:Npn \__sgraph_draw_graph:VVVVVVV #1 #2 #3 #4 #5 #6 #7
  {
    % 値のリセット
    \int_set:Nn \l___sgraph_this_value_index_int { 1 }
    % key ごとに処理
    \seq_map_inline:Nn #1
      {
        % グラフを描く幅を求める
        \prop_get:NnN #3 { ##1 } \l___sgraph_this_value_ratio_tl
        \fp_set:NV \l___sgraph_this_value_ratio_fp \l___sgraph_this_value_ratio_tl
        \fp_set:Nn \l___sgraph_this_graph_width_fp
          {
            \dim_to_fp:n { #4 } * \l___sgraph_this_value_ratio_fp
          }
        \fp_set:Nn \l___sgraph_this_end_position_fp
          {
            \l___sgraph_this_start_position_fp + \l___sgraph_this_graph_width_fp
          }
        % グラフを描画する
        \begin{ tikzpicture }
          % 長方形の描画
          \filldraw[
            \seq_item:Nn #6 { \l___sgraph_this_value_index_int }
          ]
          ( \fp_to_dim:N \l___sgraph_this_start_position_fp, 0 )
          rectangle( \fp_to_dim:N \l___sgraph_this_end_position_fp, #5 );
          % ラベルの描画
        \end{ tikzpicture }
        % 値を更新
        \fp_set_eq:NN  \l___sgraph_this_start_position_fp \l___sgraph_this_end_position_fp
        % index に +1
        \int_add:Nn \l___sgraph_this_value_index_int { 1 }
      }
  }

% [function] keys list を求める
% # (return): keys list (seq)
% # (arg): key=value list (tl)
\seq_new:N  \l___sgraph_split_by_comma_seq
\seq_new:N  \l___sgraph_keys_list_seq
\seq_new:N  \l___sgraph_key_seq
\seq_new:N  \l___sgraph_key_value_seq
\cs_generate_variant:Nn \tl_put_right:Nn {NV}

\cs_new:Npn \__sgraph_get_keys_list:Nn #1 #2
  {
    \seq_clear:N \l___sgraph_keys_list_seq
    \seq_set_split:Nnn \l___sgraph_split_by_comma_seq { , }{ #2 }
    \seq_map_inline:Nn \l___sgraph_split_by_comma_seq
      {
        \seq_set_split:Nnn  \l___sgraph_key_value_seq { = }{ ##1 }
        \seq_pop_left:NN    \l___sgraph_key_value_seq \l___sgraph_key_seq
        \seq_put_right:NV   \l___sgraph_keys_list_seq \l___sgraph_key_seq
      }
    \seq_set_eq:NN #1 \l___sgraph_keys_list_seq
  }

% [function] key=ratio を求める
% # (return): prop_val
% # (arg): key=val (prop)
\fp_new:N   \l__sgraph_data_sum_fp
\fp_new:N   \l__sgraph_values_ratio_fp
\cs_generate_variant:Nn \prop_put:Nnn { NnV }

\cs_new:Npn \__sgraph_process_data:NN #1 #2
  {
    \fp_zero:N \l__sgraph_data_sum_fp
    % #2 の value の合計値を求める
    \prop_map_inline:Nn #2
      {
        \fp_add:Nn \l__sgraph_data_sum_fp { ##2 }
      }
    % #2 の value の比率を求めて #1 に入れる
    \prop_map_inline:Nn #2
      {
        \fp_set:Nn    \l__sgraph_values_ratio_fp { ##2 / \l__sgraph_data_sum_fp }
        \prop_put:NnV #1 { ##1 } \l__sgraph_values_ratio_fp
      }
  }